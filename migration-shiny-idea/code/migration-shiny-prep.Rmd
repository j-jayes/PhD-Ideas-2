---
title: "migration-shiny-prep"
author: "JJayes"
date: "06/10/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(here)
```


# Migration shiny prep
## Purpose

I want to create a shiny app that allows you to select a year from the census and see who migrated somewhere within sweden.

I have data from the IPUMS International dataset on Sweden.


### Reading in IPUMS data
```{r}
# library(ipumsr)
# library(here)
# 
# dat <- read_ipums_micro(
#     
#     ddi = here("migration-shiny-idea", "data", "ipumsi_00002.xml"),
#     data_file = here("migration-shiny-idea", "data", "ipumsi_00002.dat.gz")
#     
# )
# 
# dat %>% head() %>% view()
# 
# dat %>% colnames()
```

### Working with just the necessary info to start with

```{r}
# df <- dat %>% 
#     select(YEAR, PARSE, BPLSE2, NAMEFRST, SEX)
# 
# df %>% 
#     sample_n(100)
# 
# df %>% 
#     write_rds(here("migration-shiny-idea", "data", "migration_info.rds"), compress = "gz")
```


```{r}
df <- read_rds(here("migration-shiny-idea", "data", "migration_info.rds"))

df %>% 
    count(PARSE, sort = T) 

df %>% 
    mutate(parish = parse_number(as.character(PARSE))) %>% 
    count(parish)
```


```{r}
map_file <- here("migration-shiny-idea", "maps", "Kommun_Sweref99TM_region.shp")

library(sf)
library(ggiraph)

map <- st_read(map_file)

instalmap %>%
  as_tibble() %>%
  count(KnKod)
```


```{r}
gg_iraph_map <- map %>% 
    ggplot() +
    geom_sf_interactive(aes(tooltip = KnNamn)) +
    theme_void()

girafe(
  ggobj = gg_iraph_map,
  width_svg = 8,
  height_svg = 4,
  options = list(
    # opts_tooltip(css = tooltip_css, delay_mouseover = 0, delay_mouseout = 0),
    opts_hover_inv(css = "opacity:0.1;"),
    opts_hover(css = "stroke-width:2;")
  )
)

```

### What about the parishes?

```{r}
library(leaflet)

map_file <- here("migration-shiny-idea", "maps", "forsamlingar_2021-01-01.shp")
map <- st_read(map_file)

map_wgs84 <- st_transform(map, "+init=epsg:4326")


map_leaflet <- map_wgs84 %>% 
    leaflet() %>% 
    addTiles() %>% 
    addPolygons(label=~namn)


```

### Fixing parish names

```{r}
df <- df %>% 
  # sample_n(10) %>% 
  mutate(kommun_living = str_sub(PARSE,1,nchar(PARSE)-5),
         kommun_living = case_when(
           
           nchar(kommun_living) == 3 ~ str_c("0", kommun_living),
           TRUE ~ kommun_living))

df %>% 
  count(kommun_living)
```

Great! There are just 288 kommuns that individuals are living in now, and we can match these to the list of kommun names that we can link to the map.

Then I can make a matrix that has the number of people born in a kommun on one axis and the number living in it on the other. Can use this axis to support the map.

```{r}
df <- df %>% 
  # sample_n(10) %>% 
  mutate(kommun_born = str_sub(BPLSE2,1,nchar(BPLSE2)-5),
         kommun_born = case_when(
           
           nchar(kommun_born) == 3 ~ str_c("0", kommun_born),
           TRUE ~ kommun_born))
```


```{r}
df_counts <- df %>% 
  count(YEAR, kommun_living, kommun_born)

# df_counts %>% 
#   write_rds(here("migration-shiny-idea", "data", "migration-counts.rds"), compress = "gz")
```


```{r}
library(readxl)
kommun_names <- read_excel(here("migration-shiny-idea", "data", "list-of-municipalities.xlsx")) %>% 
  janitor::clean_names()

kommun_names <- kommun_names %>% 
  filter(nchar(code) == 4)
```

Matching

```{r}
df_counts_named <- df_counts %>% 
  inner_join(kommun_names, by = c("kommun_living" = "code")) %>% 
  rename(kommun_living_name = name) %>% 
  inner_join(kommun_names, by = c("kommun_born" = "code")) %>% 
  rename(kommun_born_name = name)

# df_counts_named %>% 
#   write_rds(here("migration-shiny-idea", "data", "migration-counts-named.rds"), compress = "gz")

```


## Idea for flexdashboard

I want to have two plots in a single panel, and a table.

You choose a kommun and you see on a map how many people were born in it, and a plot with that same info on a column chart for, say, the 12 most prevalent municipalities.

```{r}
df_counts %>% 
  filter(YEAR == 1880,
         kommun_living == "0114") %>% 
  arrange(desc(n))
```


